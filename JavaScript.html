<!-- JavaScript.html - Shared client-side logic -->
<script>
    // ===================================================================
    // SESSION & NAVIGATION
    // ===================================================================

    var APP = {
        username: '',
        role: '',
        email: '',
        year: new Date().getFullYear(),
        calendarMonth: new Date().getMonth(),
        calendarYear: new Date().getFullYear(),
        fastingCalMonth: new Date().getMonth(),
        fastingCalYear: new Date().getFullYear(),
        dashboardData: null,
        taraweehData: {},
        fastingData: {},
        khatams: []
    };

    function initApp() {
        APP.username = sessionStorage.getItem('username') || '';
        APP.role = sessionStorage.getItem('role') || 'user';
        APP.email = sessionStorage.getItem('email') || '';

        if (!APP.username) {
            goToPage('Login');
            return;
        }

        document.getElementById('displayName').textContent = APP.username;
        document.getElementById('displayRole').textContent = APP.role;

        if (APP.role === 'admin') {
            document.getElementById('adminTabBtn').style.display = '';
        }

        loadDashboard();
    }

    function goToPage(page) {
        var url = window.location.href;
        if (url.indexOf('?') !== -1) url = url.split('?')[0];
        window.top.location.href = url + '?page=' + page;
    }

    function logout() {
        sessionStorage.clear();
        goToPage('Login');
    }

    // ===================================================================
    // TAB SWITCHING
    // ===================================================================

    function switchTab(tabName) {
        var btns = document.querySelectorAll('.tab-btn');
        var contents = document.querySelectorAll('.tab-content');

        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove('active');
            if (btns[i].getAttribute('data-tab') === tabName) btns[i].classList.add('active');
        }
        for (var j = 0; j < contents.length; j++) {
            contents[j].classList.remove('active');
            if (contents[j].id === 'tab-' + tabName) contents[j].classList.add('active');
        }

        // Lazy load tabs
        if (tabName === 'taraweeh') loadTaraweeh();
        if (tabName === 'quran') loadQuran();
        if (tabName === 'fasting') loadFasting();
        if (tabName === 'stats') loadStats();
        if (tabName === 'admin') loadAdmin();
    }

    // ===================================================================
    // LOADING OVERLAY
    // ===================================================================

    function showLoading(msg) {
        var ol = document.getElementById('loadingOverlay');
        ol.querySelector('p').textContent = msg || 'Loading...';
        ol.classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showToast(msg, type) {
        var toast = document.createElement('div');
        toast.className = 'alert show alert-' + (type || 'success');
        toast.style.cssText = 'position:fixed;top:20px;right:20px;z-index:3000;max-width:320px;animation:fadeInUp 0.3s ease';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(function () { toast.remove(); }, 3000);
    }

    // ===================================================================
    // YEAR SELECTOR
    // ===================================================================

    function changeYear() {
        APP.year = parseInt(document.getElementById('yearSelect').value);
        loadDashboard();
    }

    // ===================================================================
    // MAIN DASHBOARD LOAD
    // ===================================================================

    function loadDashboard() {
        showLoading('Loading dashboard...');
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    APP.dashboardData = result;
                    renderMyStats();
                    switchTab('taraweeh');
                }
                hideLoading();
            })
            .withFailureHandler(function (err) {
                hideLoading();
                showToast('Failed to load dashboard.', 'error');
            })
            .getDashboardData(APP.year);
    }

    function renderMyStats() {
        var data = APP.dashboardData;
        if (!data) return;

        var me = null;
        for (var i = 0; i < data.summaries.length; i++) {
            if (data.summaries[i].username.toLowerCase() === APP.username.toLowerCase()) {
                me = data.summaries[i];
                break;
            }
        }

        if (me) {
            document.getElementById('statTaraweeh').textContent = me.taraweehCount;
            document.getElementById('statStreak').textContent = me.streak;
            document.getElementById('statParas').textContent = me.totalParas;
            document.getElementById('statKhatams').textContent = me.completedKhatams;
            document.getElementById('statFasting').textContent = me.fastingCount;
        }
    }

    // ===================================================================
    // TARAWEEH CALENDAR
    // ===================================================================

    function loadTaraweeh() {
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    APP.taraweehData = result.data;
                    renderTaraweehCalendar();
                }
            })
            .getUserTaraweehData(APP.username, APP.year);
    }

    function renderTaraweehCalendar() {
        var month = APP.calendarMonth;
        var year = APP.calendarYear;
        var container = document.getElementById('taraweehCalendar');
        var title = document.getElementById('taraweehMonthTitle');

        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        title.textContent = monthNames[month] + ' ' + year;

        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var today = new Date();
        var todayStr = today.getFullYear() + '-' + pad(today.getMonth() + 1) + '-' + pad(today.getDate());

        var html = '';
        var dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        for (var h = 0; h < 7; h++) {
            html += '<div class="calendar-day-header">' + dayHeaders[h] + '</div>';
        }

        for (var e = 0; e < firstDay; e++) {
            html += '<div class="calendar-day empty"></div>';
        }

        for (var d = 1; d <= daysInMonth; d++) {
            var dateStr = year + '-' + pad(month + 1) + '-' + pad(d);
            var entry = APP.taraweehData[dateStr];
            var isToday = dateStr === todayStr;
            var isFuture = new Date(dateStr) > today;
            var classes = 'calendar-day';

            if (isToday) classes += ' today';
            if (isFuture) classes += ' future';
            if (entry && entry.completed) classes += ' completed';

            var rakaatBadge = '';
            if (entry && entry.completed && entry.rakaat) {
                rakaatBadge = '<span class="rakaat-badge">' + entry.rakaat + 'r</span>';
            }

            var onclick = isFuture ? '' : ' onclick="openTaraweehModal(\'' + dateStr + '\')"';

            html += '<div class="' + classes + '"' + onclick + '>' + d + rakaatBadge + '</div>';
        }

        container.innerHTML = html;
    }

    function prevMonth() {
        APP.calendarMonth--;
        if (APP.calendarMonth < 0) { APP.calendarMonth = 11; APP.calendarYear--; }
        renderTaraweehCalendar();
    }

    function nextMonth() {
        APP.calendarMonth++;
        if (APP.calendarMonth > 11) { APP.calendarMonth = 0; APP.calendarYear++; }
        renderTaraweehCalendar();
    }

    // Taraweeh Modal
    function openTaraweehModal(dateStr) {
        var entry = APP.taraweehData[dateStr];
        var modal = document.getElementById('taraweehModal');
        modal.classList.remove('hidden');
        modal.setAttribute('data-date', dateStr);
        document.getElementById('taraweehModalDate').textContent = dateStr;

        // Reset selection
        var opts = modal.querySelectorAll('.rakaat-option');
        for (var i = 0; i < opts.length; i++) opts[i].classList.remove('selected');

        if (entry && entry.completed) {
            document.getElementById('taraweehRemoveBtn').style.display = '';
            var r = entry.rakaat || '8';
            var sel = modal.querySelector('[data-rakaat="' + r + '"]');
            if (sel) sel.classList.add('selected');
        } else {
            document.getElementById('taraweehRemoveBtn').style.display = 'none';
            modal.querySelector('[data-rakaat="8"]').classList.add('selected');
        }
    }

    function closeTaraweehModal() {
        document.getElementById('taraweehModal').classList.add('hidden');
    }

    function selectRakaat(el) {
        var opts = el.parentElement.querySelectorAll('.rakaat-option');
        for (var i = 0; i < opts.length; i++) opts[i].classList.remove('selected');
        el.classList.add('selected');
    }

    function saveTaraweeh() {
        var modal = document.getElementById('taraweehModal');
        var dateStr = modal.getAttribute('data-date');
        var sel = modal.querySelector('.rakaat-option.selected');
        var rakaat = sel ? parseInt(sel.getAttribute('data-rakaat')) : 8;

        closeTaraweehModal();
        showLoading('Saving...');

        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast(result.message);
                    loadTaraweeh();
                    refreshDashboard();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .withFailureHandler(function () { hideLoading(); showToast('Error saving.', 'error'); })
            .logTaraweeh(APP.username, dateStr, true, rakaat);
    }

    function removeTaraweeh() {
        var modal = document.getElementById('taraweehModal');
        var dateStr = modal.getAttribute('data-date');
        closeTaraweehModal();
        showLoading('Removing...');

        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast(result.message);
                    loadTaraweeh();
                    refreshDashboard();
                }
            })
            .withFailureHandler(function () { hideLoading(); })
            .logTaraweeh(APP.username, dateStr, false, 0);
    }

    // ===================================================================
    // QURAN / KHATAM
    // ===================================================================

    function loadQuran() {
        showLoading('Loading Quran progress...');
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    APP.khatams = result.khatams;
                    renderKhatams();
                }
            })
            .withFailureHandler(function () { hideLoading(); })
            .getUserKhatams(APP.username, APP.year);
    }

    function renderKhatams() {
        var container = document.getElementById('khatamList');
        if (APP.khatams.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary)">' +
                '<p style="font-size:40px;margin-bottom:12px">üìñ</p>' +
                '<p>No Khatams started yet for ' + APP.year + '</p>' +
                '<p style="font-size:13px;margin-top:8px">Click "Start New Khatam" to begin your journey</p></div>';
            return;
        }

        var html = '';
        for (var k = 0; k < APP.khatams.length; k++) {
            var kh = APP.khatams[k];
            var isComplete = kh.paraCount >= 30;
            var pct = Math.round((kh.paraCount / 30) * 100);
            var typeIcon = kh.type === 'Arabic' ? 'üïã' : 'üåç';
            var statusClass = isComplete ? ' completed' : '';

            html += '<div class="card' + statusClass + '">';
            html += '<div class="card-header">';
            html += '<h2>' + typeIcon + ' ' + kh.type + ' Khatam' + (isComplete ? ' ‚úÖ' : '') + '</h2>';
            html += '<div style="display:flex;gap:8px;align-items:center">';
            html += '<span style="font-size:13px;color:var(--text-secondary)">' + kh.paraCount + '/30</span>';
            html += '<button class="btn btn-danger btn-sm" onclick="deleteKhatamConfirm(\'' + kh.khatamId + '\')">üóëÔ∏è</button>';
            html += '</div></div>';

            html += '<div class="progress-bar-container"><div class="progress-bar-fill" style="width:' + pct + '%"></div></div>';

            html += '<div class="quran-grid">';
            for (var p = 1; p <= 30; p++) {
                var done = kh.parasCompleted.indexOf(p) !== -1;
                var cls = 'para-box' + (done ? ' completed' : '');
                html += '<div class="' + cls + '" onclick="toggleParaClick(\'' + kh.khatamId + '\',' + p + ')">' + p + '</div>';
            }
            html += '</div></div>';
        }

        container.innerHTML = html;
    }

    function startNewKhatam(type) {
        showLoading('Starting new Khatam...');
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast(result.message);
                    loadQuran();
                    refreshDashboard();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .withFailureHandler(function () { hideLoading(); showToast('Error.', 'error'); })
            .createKhatam(APP.username, type);
    }

    function toggleParaClick(khatamId, para) {
        showLoading('Updating...');
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast(result.message);
                    loadQuran();
                    refreshDashboard();
                } else {
                    showToast(result.error, 'error');
                }
            })
            .withFailureHandler(function () { hideLoading(); showToast('Error.', 'error'); })
            .togglePara(APP.username, khatamId, para);
    }

    function deleteKhatamConfirm(khatamId) {
        if (!confirm('Delete this entire Khatam and all its progress? This cannot be undone.')) return;
        showLoading('Deleting...');
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast(result.message);
                    loadQuran();
                    refreshDashboard();
                }
            })
            .withFailureHandler(function () { hideLoading(); })
            .deleteKhatam(APP.username, khatamId);
    }

    // ===================================================================
    // FASTING CALENDAR
    // ===================================================================

    function loadFasting() {
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    APP.fastingData = result.data;
                    renderFastingCalendar();
                }
            })
            .getUserFastingData(APP.username, APP.year);
    }

    function renderFastingCalendar() {
        var month = APP.fastingCalMonth;
        var year = APP.fastingCalYear;
        var container = document.getElementById('fastingCalendar');
        var title = document.getElementById('fastingMonthTitle');

        var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        title.textContent = monthNames[month] + ' ' + year;

        var firstDay = new Date(year, month, 1).getDay();
        var daysInMonth = new Date(year, month + 1, 0).getDate();
        var today = new Date();
        var todayStr = today.getFullYear() + '-' + pad(today.getMonth() + 1) + '-' + pad(today.getDate());

        var html = '';
        var dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        for (var h = 0; h < 7; h++) {
            html += '<div class="calendar-day-header">' + dayHeaders[h] + '</div>';
        }

        for (var e = 0; e < firstDay; e++) {
            html += '<div class="calendar-day empty"></div>';
        }

        for (var d = 1; d <= daysInMonth; d++) {
            var dateStr = year + '-' + pad(month + 1) + '-' + pad(d);
            var entry = APP.fastingData[dateStr];
            var isToday = dateStr === todayStr;
            var isFuture = new Date(dateStr) > today;
            var classes = 'calendar-day';

            if (isToday) classes += ' today';
            if (isFuture) classes += ' future';
            if (entry && entry.fasted) classes += ' completed';

            var onclick = isFuture ? '' : ' onclick="toggleFasting(\'' + dateStr + '\')"';
            html += '<div class="' + classes + '"' + onclick + '>' + d + '</div>';
        }

        container.innerHTML = html;
    }

    function prevFastingMonth() {
        APP.fastingCalMonth--;
        if (APP.fastingCalMonth < 0) { APP.fastingCalMonth = 11; APP.fastingCalYear--; }
        renderFastingCalendar();
    }

    function nextFastingMonth() {
        APP.fastingCalMonth++;
        if (APP.fastingCalMonth > 11) { APP.fastingCalMonth = 0; APP.fastingCalYear++; }
        renderFastingCalendar();
    }

    function toggleFasting(dateStr) {
        var entry = APP.fastingData[dateStr];
        var fasted = !(entry && entry.fasted);

        showLoading('Saving...');
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) {
                    showToast(result.message);
                    loadFasting();
                    refreshDashboard();
                }
            })
            .withFailureHandler(function () { hideLoading(); })
            .logFasting(APP.username, dateStr, fasted, '');
    }

    // ===================================================================
    // STATISTICS & LEADERBOARD
    // ===================================================================

    function loadStats() {
        renderStats();
    }

    function renderStats() {
        var data = APP.dashboardData;
        if (!data) return;

        // --- Charts ---
        renderBarChart('taraweehChart', data.summaries, 'taraweehCount', 'Taraweeh Prayers', 'var(--green)');
        renderBarChart('quranChart', data.summaries, 'totalParas', 'Total Paras Read', 'var(--gold)');
        renderBarChart('fastingChart', data.summaries, 'fastingCount', 'Fasting Days', 'var(--blue)');

        // --- Leaderboard ---
        renderLeaderboard(data.summaries);

        // --- Badges ---
        renderBadges(data.badges);
    }

    function renderBarChart(containerId, summaries, field, title, color) {
        var container = document.getElementById(containerId);
        if (!container) return;

        var max = 0;
        for (var i = 0; i < summaries.length; i++) {
            if (summaries[i][field] > max) max = summaries[i][field];
        }
        if (max === 0) max = 1;

        var html = '<h3 style="margin-bottom:12px;font-size:14px;color:var(--text-secondary)">' + title + '</h3>';
        for (var j = 0; j < summaries.length; j++) {
            var s = summaries[j];
            var pct = Math.round((s[field] / max) * 100);
            var isMe = s.username.toLowerCase() === APP.username.toLowerCase();

            html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
            html += '<span style="min-width:80px;font-size:12px;text-align:right;color:' + (isMe ? 'var(--gold)' : 'var(--text-secondary)') + '">' + s.username + '</span>';
            html += '<div style="flex:1;background:var(--bg-secondary);border-radius:4px;height:24px;overflow:hidden">';
            html += '<div style="height:100%;width:' + pct + '%;background:' + color + ';border-radius:4px;transition:width 0.5s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:11px;font-weight:600;color:var(--bg-primary)">' + (s[field] > 0 ? s[field] : '') + '</div>';
            html += '</div></div>';
        }
        container.innerHTML = html;
    }

    function renderLeaderboard(summaries) {
        var container = document.getElementById('leaderboardTable');
        if (!container) return;

        var html = '<table class="family-table"><thead><tr>';
        html += '<th>#</th><th>Name</th><th>üïå Taraweeh</th><th>üìñ Paras</th><th>üçΩÔ∏è Fasts</th><th>üìø Khatams</th><th>‚≠ê Score</th>';
        html += '</tr></thead><tbody>';

        for (var i = 0; i < summaries.length; i++) {
            var s = summaries[i];
            var isMe = s.username.toLowerCase() === APP.username.toLowerCase();
            var rankEmoji = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : (i === 2 ? 'ü•â' : (i + 1)));

            html += '<tr style="' + (isMe ? 'background:rgba(201,168,76,0.05)' : '') + '">';
            html += '<td class="rank">' + rankEmoji + '</td>';
            html += '<td style="font-weight:' + (isMe ? '700' : '400') + ';color:' + (isMe ? 'var(--gold)' : 'var(--text-primary)') + '">' + s.username + '</td>';
            html += '<td>' + s.taraweehCount + '</td>';
            html += '<td>' + s.totalParas + '</td>';
            html += '<td>' + s.fastingCount + '</td>';
            html += '<td>' + s.completedKhatams + '</td>';
            html += '<td style="font-weight:700;color:var(--gold)">' + s.score + '</td>';
            html += '</tr>';
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderBadges(badges) {
        var container = document.getElementById('badgesContainer');
        if (!container) return;

        if (!badges || badges.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:20px">No badges earned yet. Keep going! üí™</p>';
            return;
        }

        var html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px">';
        for (var i = 0; i < badges.length; i++) {
            var b = badges[i];
            html += '<div class="stat-card" style="text-align:left;padding:16px">';
            html += '<div style="font-size:28px;margin-bottom:6px">' + b.emoji + '</div>';
            html += '<div style="font-weight:700;font-size:14px;margin-bottom:2px">' + b.name + '</div>';
            html += '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">' + b.desc + '</div>';
            html += '<div style="font-size:11px;color:var(--gold)">';
            for (var e = 0; e < b.earners.length; e++) {
                html += '<span style="display:inline-block;background:rgba(201,168,76,0.15);padding:2px 8px;border-radius:10px;margin:2px">' + b.earners[e] + '</span>';
            }
            html += '</div></div>';
        }
        html += '</div>';
        container.innerHTML = html;
    }

    // ===================================================================
    // ADMIN PANEL
    // ===================================================================

    function loadAdmin() {
        if (APP.role !== 'admin') return;
        showLoading('Loading users...');
        google.script.run
            .withSuccessHandler(function (result) {
                hideLoading();
                if (result.success) renderAdminUsers(result.users);
            })
            .withFailureHandler(function () { hideLoading(); })
            .adminGetAllUsers(APP.username);
    }

    function renderAdminUsers(users) {
        var container = document.getElementById('adminUserList');
        var html = '';

        for (var i = 0; i < users.length; i++) {
            var u = users[i];
            var isMe = u.username.toLowerCase() === APP.username.toLowerCase();

            html += '<div class="admin-user-row">';
            html += '<div class="admin-user-info">';
            html += '<span class="name">' + u.username + (u.role === 'admin' ? ' üëë' : '') + '</span>';
            html += '<span class="email">' + u.email + ' ¬∑ Joined ' + u.created + '</span>';
            html += '</div>';
            html += '<div class="admin-actions">';

            if (!isMe) {
                html += '<button class="btn btn-secondary btn-sm" onclick="adminResetPw(\'' + u.username + '\')">üîë Reset PW</button>';
                var toggleRole = u.role === 'admin' ? 'user' : 'admin';
                var toggleLabel = u.role === 'admin' ? '‚¨á Demote' : '‚¨Ü Promote';
                html += '<button class="btn btn-secondary btn-sm" onclick="adminToggleRole(\'' + u.username + '\',\'' + toggleRole + '\')">' + toggleLabel + '</button>';
                html += '<button class="btn btn-danger btn-sm" onclick="adminDeleteUsr(\'' + u.username + '\')">üóë</button>';
            } else {
                html += '<span style="font-size:12px;color:var(--text-muted)">You</span>';
            }

            html += '</div></div>';
        }

        container.innerHTML = html;
    }

    function adminResetPw(username) {
        var pw = prompt('Enter new password for ' + username + ':');
        if (!pw) return;
        showLoading('Resetting...');
        google.script.run
            .withSuccessHandler(function (r) { hideLoading(); showToast(r.success ? r.message : r.error, r.success ? 'success' : 'error'); })
            .withFailureHandler(function () { hideLoading(); })
            .adminResetPassword(APP.username, username, pw);
    }

    function adminToggleRole(username, newRole) {
        if (!confirm('Change ' + username + ' to ' + newRole + '?')) return;
        showLoading('Updating...');
        google.script.run
            .withSuccessHandler(function (r) { hideLoading(); showToast(r.success ? r.message : r.error, r.success ? 'success' : 'error'); loadAdmin(); })
            .withFailureHandler(function () { hideLoading(); })
            .adminChangeRole(APP.username, username, newRole);
    }

    function adminDeleteUsr(username) {
        if (!confirm('DELETE user "' + username + '"? This cannot be undone!')) return;
        showLoading('Deleting...');
        google.script.run
            .withSuccessHandler(function (r) { hideLoading(); showToast(r.success ? r.message : r.error, r.success ? 'success' : 'error'); loadAdmin(); })
            .withFailureHandler(function () { hideLoading(); })
            .adminDeleteUser(APP.username, username);
    }

    // ===================================================================
    // HELPERS
    // ===================================================================

    function pad(n) { return n < 10 ? '0' + n : '' + n; }

    function refreshDashboard() {
        google.script.run
            .withSuccessHandler(function (result) {
                if (result.success) {
                    APP.dashboardData = result;
                    renderMyStats();
                }
            })
            .getDashboardData(APP.year);
    }
</script>